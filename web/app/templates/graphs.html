{% extends "base.html" %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<div class="gray-box">
    <div class="medium-bold-text">Graphique des heures enregistrées par Hourglass</div>
    <canvas id="myChart" data-chart='{{ chart_data_json|safe }}' style="width: 80%; max-width: 100%; height: 400px;"></canvas>
</div>

<div class="gray-box">
    <div class="medium-bold-text">Heures réalisées chaque mois</div>
    <canvas id="monthlyChart"
            data-chart='{{ monthly_chart_data_json|safe }}'
            style="width: 80%; max-width: 100%; height: 400px;"></canvas>
</div>

<div class="gray-box">
    <div class="medium-bold-text">Répartition des heures par serveur</div>
    <canvas id="serversPieChart"
            data-chart='{{ chart_data_json_pie_server|safe }}'
            style="width: 400px; max-width: 400px; height: 300px; display: block; margin: auto;"></canvas>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('myChart');
    const chartData = JSON.parse(canvas.dataset.chart);

    const ctx = canvas.getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels, // dates au format YYYY-MM-DD
            datasets: [{
                label: 'Heures',
                data: chartData.hours,
                borderColor: '#461f43',
                backgroundColor: '#2B1329',
                tension: 0.2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                tooltip: {
                    enabled: true,
                    callbacks: {
                        title: (items) => {
                            const date = new Date(items[0].parsed.x);
                            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day' },
                    ticks: {
                        source: 'data',
                        callback: (val, index, ticks) => {
                            const date = new Date(ticks[index].value);
                            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                        }
                    },
                    title: { display: true, text: 'Temps' }
                },
                y: {
                    title: { display: true, text: 'Heures' },
                    beginAtZero: true
                }
            }
        }
    });
    const monthlyCanvas = document.getElementById('monthlyChart');
    const monthlyData = JSON.parse(monthlyCanvas.dataset.chart);
    const monthlyCtx = monthlyCanvas.getContext('2d');

    // Calcul de la moyenne : exclut le dernier mois
    const hoursForAvg = monthlyData.hours.slice(0, -1);
    const avg = hoursForAvg.reduce((a, b) => a + b, 0) / hoursForAvg.length;

    new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: monthlyData.labels,
            datasets: [
                {
                    label: 'Heures réalisées par mois',
                    data: monthlyData.hours,
                    backgroundColor: '#2B1329',
                    borderColor: '#461f43',
                    borderWidth: 1,
                    borderRadius: 6
                },
                {
                    label: 'Moyenne : ' + avg.toFixed(1) + ' h', // valeur affichée dans la légende
                    data: Array(monthlyData.hours.length).fill(avg),
                    type: 'line',
                    borderColor: '#FFA500',   // couleur de la ligne
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0           // pas de points, donc pas de tooltip
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                tooltip: {
                    enabled: true,  // les tooltips restent sur les barres seulement
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + ' heures';
                        }
                    }
                }
            },
            scales: {
                x: { title: { display: true, text: 'Mois' } },
                y: { beginAtZero: true, title: { display: true, text: 'Heures' } }
            }
        }
    });
    // ------------------- Graphique 3 : Pie chart heures par serveur -------------------
    // Fonction pour générer n couleurs pâles distinctes
    function generateColors(n) {
        const colors = [];
        const hueStep = 360 / n;
        for (let i = 0; i < n; i++) {
            const hue = i * hueStep;
            colors.push(`hsl(${hue}, 50%, 50%)`); // couleurs pâles
        }
        return colors;
    }

    const pieCanvas = document.getElementById('serversPieChart');
    const pieData = JSON.parse(pieCanvas.dataset.chart);
    const pieCtx = pieCanvas.getContext('2d');

    // Génération dynamique des couleurs
    const backgroundColors = generateColors(pieData.labels.length);

    new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: pieData.labels,
            datasets: [{
                data: pieData.hours,
                backgroundColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'right' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a,b)=>a+b,0);
                            const value = context.parsed;
                            const percentage = ((value/total)*100).toFixed(1);
                            return `${context.label}: ${value} h (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}




